<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>X-Axis Accumulation Trigger</title>

    <style>
        body {
            font-family: system-ui, sans-serif;
            background: #0e0e11;
            color: #eaeaf0;
            margin: 0;
            padding: 16px;
        }

        h1 {
            font-size: 18px;
            margin-bottom: 12px;
        }

        .controls {
            margin-bottom: 16px;
        }

        label {
            font-size: 12px;
            opacity: 0.85;
        }

        input[type="range"] {
            width: 100%;
        }

        .bar-wrap {
            background: #1a1a22;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .bar {
            height: 80px;
            background: linear-gradient(180deg, #4af, #147);
            transform-origin: center;
            transform: scaleY(0);
            border-radius: 4px;
            transition: transform 0.05s linear;
        }

        .indicator {
            height: 40px;
            border-radius: 8px;
            background: #222;
            box-shadow: inset 0 0 0 1px #333;
            transition: background 0.1s;
        }

        .indicator.on {
            background: #ff4a4a;
            box-shadow: 0 0 16px rgba(255, 74, 74, 0.6);
        }

        .readout {
            font-size: 12px;
            margin-top: 8px;
            opacity: 0.85;
        }
    </style>
</head>

<body>

    <h1>X-Axis 100 ms Accumulation Trigger</h1>

    <div class="controls">
        <label>
            Threshold (Σx): <span id="thresholdLabel">1.0</span>
        </label>
        <input id="thresholdSlider" type="range" min="0.1" max="10" step="0.1" value="1.0" />
    </div>

    <div class="bar-wrap">
        <div class="bar" id="barX"></div>
        <div class="readout">
            Σx (last 100 ms): <span id="sumLabel">0.00</span>
        </div>
    </div>

    <div class="indicator" id="indicator"></div>

    <script>
        const barX = document.getElementById("barX");
        const indicator = document.getElementById("indicator");
        const sumLabel = document.getElementById("sumLabel");

        const thresholdSlider = document.getElementById("thresholdSlider");
        const thresholdLabel = document.getElementById("thresholdLabel");

        let threshold = parseFloat(thresholdSlider.value);
        thresholdLabel.textContent = threshold.toFixed(1);

        thresholdSlider.oninput = () => {
            threshold = parseFloat(thresholdSlider.value);
            thresholdLabel.textContent = threshold.toFixed(1);
        };

        // Rolling samples: { t, x }
        const samples = [];
        const WINDOW_MS = 100;

        function pruneSamples(now) {
            const cutoff = now - WINDOW_MS;
            while (samples.length && samples[0].t < cutoff) {
                samples.shift();
            }
        }

        function cumulativeX() {
            let sum = 0;
            for (const s of samples) sum += s.x;
            return sum;
        }

        function handleMotion(e) {
            const a = e.acceleration; // gravity-compensated
            if (!a || a.x == null) return;

            const now = performance.now();
            samples.push({ t: now, x: a.x });
            pruneSamples(now);

            const sumX = cumulativeX();
            sumLabel.textContent = sumX.toFixed(2);

            // Visual bar (scaled for visibility)
            const visualScale = Math.max(-1, Math.min(1, sumX / threshold));
            barX.style.transform = `scaleY(${Math.abs(visualScale)})`;

            if (Math.abs(sumX) > threshold) {
                indicator.classList.add("on");
            } else {
                indicator.classList.remove("on");
            }
        }

        async function init() {
            if (typeof DeviceMotionEvent !== "undefined" &&
                typeof DeviceMotionEvent.requestPermission === "function") {

                const btn = document.createElement("button");
                btn.textContent = "Enable Accelerometer";
                btn.style.padding = "12px";
                btn.onclick = async () => {
                    const res = await DeviceMotionEvent.requestPermission();
                    if (res === "granted") {
                        window.addEventListener("devicemotion", handleMotion);
                        btn.remove();
                    }
                };
                document.body.prepend(btn);

            } else {
                window.addEventListener("devicemotion", handleMotion);
            }
        }

        init();
    </script>

</body>

</html>
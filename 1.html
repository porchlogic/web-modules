<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Speed Drone — Clean Build</title>
<style>
  * { box-sizing: border-box; touch-action: manipulation; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:12px; background:#111; color:#eee; }
  .box { border:1px solid #444; padding:12px; border-radius:10px; margin:10px 0; background:#181818; }
  button { font-size:16px; padding:10px 14px; margin:6px 6px 6px 0; background:#222; color:#eee; border:1px solid #555; border-radius:8px; }
  label { display:inline-flex; align-items:center; gap:8px; margin-right:12px; }
  input[type=range] { width:180px; }
  select { background:#000; color:#eee; border:1px solid #444; border-radius:6px; padding:6px; }
  #log { font:12px/1.4 ui-monospace, Menlo, Consolas, monospace; white-space:pre-wrap; max-height:160px; overflow:auto; background:#000; padding:8px; border-radius:6px; }
  .kv { display:flex; gap:10px; flex-wrap:wrap; }
  .kv > div { min-width:150px; }
  .lamp { display:inline-block; width:10px; height:10px; border-radius:50%; background:#700; margin-left:6px; vertical-align:middle; }
  .ok { background:#0c4; }
</style>
</head>
<body>
<h1>Speed Drone — Clean Build</h1>

<div class="box">
  <div id="status">Booting… <span id="lamp" class="lamp"></span></div>
  <div id="last">Last action: —</div>
</div>

<div class="box">
  <div class="kv">
    <button id="btnAll">Start All</button>
    <button id="btnMotion">Enable Motion</button>
    <button id="btnGPS">Start GPS</button>
    <button id="btnAudio">Start Audio</button>
    <button id="btnStopGPS" disabled>Stop GPS</button>
    <button id="btnMute" disabled>Mute</button>
    <button id="btnReset">Reset</button>
  </div>
  <div style="margin-top:6px;">
    <label>Master Vol <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9"><span id="volv">0.90</span></label>
    <label>Max speed (m/s) <input id="vmax" type="range" min="4" max="20" value="12" step="1"><span id="vmaxv">12</span></label>
    <label>Rumble <input id="rlev" type="range" min="0" max="1" value="0.7" step="0.01"><span id="rlevv">0.70</span></label>
    <label>Chorus <input id="clev" type="range" min="0" max="1" value="0.8" step="0.01"><span id="clevv">0.80</span></label>
  </div>
  <div style="margin-top:6px;">
    <label>Key
      <select id="key">
        <option>C</option><option>C#</option><option>D</option><option>D#</option>
        <option>E</option><option>F</option><option>F#</option><option>G</option>
        <option>G#</option><option>A</option><option>A#</option><option>B</option>
      </select>
    </label>
    <label>Scale
      <select id="scale">
        <option value="major" selected>Major</option>
        <option value="minor">Minor</option>
        <option value="dorian">Dorian</option>
        <option value="mixolydian">Mixolydian</option>
        <option value="pentmaj">Pentatonic Major</option>
        <option value="pentmin">Pentatonic Minor</option>
      </select>
    </label>
    <label>Chord
      <select id="chord">
        <option value="power" selected>Power (1+5)</option>
        <option value="maj">Major (1+3+5)</option>
        <option value="min">Minor (1+3b+5)</option>
        <option value="sus2">Sus2 (1+2+5)</option>
        <option value="sus4">Sus4 (1+4+5)</option>
      </select>
    </label>
    <label><input id="quant" type="checkbox" checked> Quantize to scale</label>
  </div>
</div>

<div class="box">
  <div class="kv">
    <div>Fused (m/s): <b id="v_fused">-</b></div>
    <div>Fused (mph): <b id="v_fused_mph">-</b></div>
    <div>GPS (m/s): <b id="v_gps">-</b></div>
    <div>Accel (m/s): <b id="v_acc">-</b></div>
    <div>Accel Hz: <b id="hz">0</b></div>
    <div>GPS acc (m): <b id="acc">-</b></div>
    <div>Dist since anchor (m): <b id="dist">0</b></div>
    <div>Fix age (ms): <b id="fixAge">-</b></div>
  </div>
</div>

<div class="box">
  <div><b>Log</b></div>
  <div id="log"></div>
</div>

<script>
(function(){
  // ----- helpers
  function $(id){ return document.getElementById(id); }
  function log(m){ var t=new Date().toLocaleTimeString(); var L=$('log'); L.textContent+='['+t+'] '+m+'\n'; L.scrollTop=L.scrollHeight; $('last').textContent='Last action: '+m; }
  function setStatus(m){ $('status').textContent=m; }
  $('lamp').classList.add('ok'); setStatus('Script OK');

  // Single, de-duplicated tap binder: prefers pointerdown, falls back to click; ignores duplicates within 300ms
  var usePointer = ('onpointerdown' in window);
  var lastTapAt = 0;
  function bindTap(el, fn){
    if(!el) return;
    function handler(e){
      var now = performance.now();
      if (now - lastTapAt < 300) return; // dedupe
      lastTapAt = now;
      try { fn(e); } catch(err){ log('handler error: '+err); }
    }
    if (usePointer) el.addEventListener('pointerdown', handler, false);
    else el.addEventListener('click', handler, false);
  }

  // ----- UI refs
  var ui = {
    btnAll:$('btnAll'), btnMotion:$('btnMotion'), btnGPS:$('btnGPS'),
    btnAudio:$('btnAudio'), btnStopGPS:$('btnStopGPS'), btnMute:$('btnMute'), btnReset:$('btnReset'),
    vol:$('vol'), volv:$('volv'), vmax:$('vmax'), vmaxv:$('vmaxv'), rlev:$('rlev'), rlevv:$('rlevv'), clev:$('clev'), clevv:$('clevv'),
    key:$('key'), scale:$('scale'), chord:$('chord'), quant:$('quant'),
    v_fused:$('v_fused'), v_fused_mph:$('v_fused_mph'), v_gps:$('v_gps'), v_acc:$('v_acc'),
    hz:$('hz'), acc:$('acc'), dist:$('dist'), fixAge:$('fixAge')
  };

  // ----- sliders
  var VMAX = parseFloat(ui.vmax.value); ui.vmaxv.textContent = ui.vmax.value;
  var RUMBLE_TRIM = parseFloat(ui.rlev.value); ui.rlevv.textContent = ui.rlev.value;
  var CHORUS_TRIM = parseFloat(ui.clev.value); ui.clevv.textContent = ui.clev.value;
  var MASTER_VOL = parseFloat(ui.vol.value); ui.volv.textContent = ui.vol.value;

  ui.vmax.oninput=function(e){ VMAX=parseFloat(e.target.value); ui.vmaxv.textContent=e.target.value; };
  ui.rlev.oninput=function(e){ RUMBLE_TRIM=parseFloat(e.target.value); ui.rlevv.textContent=e.target.value; };
  ui.clev.oninput=function(e){ CHORUS_TRIM=parseFloat(e.target.value); ui.clevv.textContent=e.target.value; };
  ui.vol.oninput=function(e){ MASTER_VOL=parseFloat(e.target.value); ui.volv.textContent=e.target.value; if(masterGain&&ac){ masterGain.gain.setTargetAtTime(MASTER_VOL, ac.currentTime, 0.05);} };

  // ----- math
  function toRad(d){ return d*Math.PI/180; }
  function haversine(a,b){ var R=6371000, dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
    var s1=Math.sin(dLat/2), s2=Math.sin(dLon/2), v=s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
    return 2*R*Math.asin(Math.min(1,Math.sqrt(v))); }
  function clamp01(x){ return Math.min(1, Math.max(0, x)); }
  function smoothstep(x){ x=clamp01(x); return x*x*(3-2*x); }
  var NOTE_NAMES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  function midiToHz(m){ return 440*Math.pow(2,(m-69)/12); }
  var SCALES={major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],dorian:[0,2,3,5,7,9,10],mixolydian:[0,2,4,5,7,9,10],pentmaj:[0,2,4,7,9],pentmin:[0,3,5,7,10]};
  function speedToMidiInScale(n01, rootSemi, scaleName){
    var steps=SCALES[scaleName]||SCALES.major, total=steps.length*2;
    var idx=Math.round(n01*total), octave=Math.floor(idx/steps.length);
    var deg=steps[Math.min(steps.length-1, idx%steps.length)];
    var root=4*12+rootSemi; return root+deg+octave*12;
  }
  function chordIntervals(name){ if(name==='maj')return[0,4,7]; if(name==='min')return[0,3,7]; if(name==='sus2')return[0,2,7]; if(name==='sus4')return[0,5,7]; return[0,7]; }

  // ----- motion
  var lastMotionT=null, emaHz=0, gX=0,gY=0,gZ=0, LPF_G=0.02, v_acc=0, NOISE_FLOOR=0.12, BETA=0.6;
  function onMotion(e){
    var t=performance.now()/1000, dt=lastMotionT?(t-lastMotionT):0; lastMotionT=t;
    if (dt<=0) return; if (dt>0.25) dt=0.25;
    var instHz=1/Math.max(0.001,dt); emaHz=0.8*emaHz+0.2*instHz; ui.hz.textContent=instHz.toFixed(1);
    var ax,ay,az;
    if (e.acceleration && (e.acceleration.x!=null||e.acceleration.y!=null||e.acceleration.z!=null)){
      ax=e.acceleration.x||0; ay=e.acceleration.y||0; az=e.acceleration.z||0;
    } else {
      var ag=e.accelerationIncludingGravity||{}; var ix=ag.x||0, iy=ag.y||0, iz=ag.z||0;
      gX=(1-LPF_G)*gX+LPF_G*ix; gY=(1-LPF_G)*gY+LPF_G*iy; gZ=(1-LPF_G)*gZ+LPF_G*iz;
      ax=ix-gX; ay=iy-gY; az=iz-gZ;
    }
    var amag=Math.sqrt(ax*ax+ay*ay+az*az), a_eff=Math.max(0, amag - NOISE_FLOOR);
    v_acc += a_eff*dt; v_acc -= (v_acc*BETA)*dt; if (v_acc<0) v_acc=0;
    ui.v_acc.textContent=v_acc.toFixed(2);
  }
  function enableMotion(){
    if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission==='function'){
      // iOS path — not used on your device, but safe
      DeviceMotionEvent.requestPermission().then(function(p){
        if (p!=='granted'){ setStatus('Motion permission denied'); return; }
        window.addEventListener('devicemotion', onMotion, false);
        setStatus('Accelerometer active'); log('Motion enabled');
      }).catch(function(err){ setStatus('Motion error'); log('Motion error: '+err); });
    } else {
      window.addEventListener('devicemotion', onMotion, false);
      setStatus('Accelerometer active'); log('Motion enabled');
    }
  }

  // ----- GPS
  var gpsWatch=null, lastFixAge=Infinity, lastPos=null, anchorPos=null, distSinceAnchor=0, gpsSpeed=null, lastFix=null;
  function startGPS(){
    if (!navigator.geolocation){ setStatus('No geolocation'); return; }
    try{
      gpsWatch = navigator.geolocation.watchPosition(onGPS, function(e){
        setStatus('GPS error: '+e.message); log('GPS error: '+e.message);
      }, { enableHighAccuracy:true, maximumAge:1000, timeout:10000 });
      setStatus('GPS started…'); log('GPS watch started');
      ui.btnGPS.disabled=true; ui.btnStopGPS.disabled=false;
    }catch(err){ setStatus('GPS start error'); log('GPS start error: '+err); }
  }
  function onGPS(pos){
    var c=pos.coords, now=Date.now();
    lastFixAge=now-pos.timestamp; ui.fixAge.textContent=lastFixAge.toFixed(0);
    ui.acc.textContent = c.accuracy!=null? Math.round(c.accuracy): '-';
    var cur={lat:c.latitude, lon:c.longitude, acc:c.accuracy||50, t:pos.timestamp};
    var v = (c.speed==null || isNaN(c.speed)) ? null : c.speed;
    if (!v && lastPos){ var dt=Math.max(0.25,(cur.t-lastPos.t)/1000), d=haversine(lastPos,cur); v=d/dt; }
    gpsSpeed = (v!=null && isFinite(v) && v>=0) ? v : null;
    ui.v_gps.textContent = gpsSpeed==null? '-' : gpsSpeed.toFixed(2);
    if (anchorPos==null) anchorPos=cur;
    if (lastPos){ var step=haversine(lastPos,cur); if (step > Math.max((c.accuracy||30)*0.5, 2)) distSinceAnchor += step; }
    lastPos=cur; ui.dist.textContent = distSinceAnchor.toFixed(1);
    lastFix = {cur:cur, accuracy:c.accuracy||50};
    setStatus('GPS fix OK');
  }
  function stopGPS(){
    if (gpsWatch!=null){ navigator.geolocation.clearWatch(gpsWatch); gpsWatch=null; }
    ui.btnGPS.disabled=false; ui.btnStopGPS.disabled=true; setStatus('GPS stopped'); log('GPS stopped');
  }

  // ----- fuse + audio
  var mode='ACCEL_LEAD', v_fused=0, ACC_OK=20, FIX_STALE=1500, D_ANCHOR=10, SPEED_DISAG=1.5, A_LEAD=0.9;
  function maybeSwitchModes(){
    var accOK = lastFix && (lastFix.accuracy <= ACC_OK);
    var fixFresh = lastFixAge <= FIX_STALE;
    var disagree = (gpsSpeed!=null) && (Math.abs((v_acc||0) - gpsSpeed) >= SPEED_DISAG);
    var accelWake = (v_acc>0.1) || (emaHz>5 && v_acc>0.05);
    if (mode==='ACCEL_LEAD'){
      if (accOK && fixFresh && ((distSinceAnchor >= D_ANCHOR) || disagree)) {
        mode='GPS_ANCHOR';
        if (gpsSpeed!=null) v_fused = 0.3*v_fused + 0.7*gpsSpeed;
        log('Switch -> GPS_ANCHOR');
      }
    } else {
      if (accelWake || !accOK || !fixFresh || gpsSpeed==null){
        mode='ACCEL_LEAD'; anchorPos = lastPos; distSinceAnchor = 0; log('Switch -> ACCEL_LEAD');
      }
    }
  }

  var ac=null, masterGain=null, drone=null, muted=false;
  function makeDrone(ctx){
    var master = ctx.createGain(); master.gain.value = MASTER_VOL;
    var rMix = ctx.createGain(); rMix.gain.value = 0.0;
    var saw = ctx.createOscillator(); saw.type='sawtooth'; saw.frequency.value=40;
    var sine = ctx.createOscillator(); sine.type='sine'; sine.frequency.value=22;
    var sG = ctx.createGain(); sG.gain.value=0.12; var siG = ctx.createGain(); siG.gain.value=0.10;
    saw.connect(sG); sG.connect(rMix); sine.connect(siG); siG.connect(rMix);
    var cMix = ctx.createGain(); cMix.gain.value = 0.0;
    var p1 = ctx.createOscillator(); p1.type='sine';
    var p2 = ctx.createOscillator(); p2.type='sine';
    var p3 = ctx.createOscillator(); p3.type='sine';
    var p1G = ctx.createGain(); p1G.gain.value=0.16;
    var p2G = ctx.createGain(); p2G.gain.value=0.12;
    var p3G = ctx.createGain(); p3G.gain.value=0.10;
    p1.connect(p1G); p1G.connect(cMix); p2.connect(p2G); p2G.connect(cMix); p3.connect(p3G); p3G.connect(cMix);
    cMix.connect(master); rMix.connect(master); master.connect(ctx.destination);
    try{ saw.start(); sine.start(); p1.start(); p2.start(); p3.start(); }catch(e){}
    return {
      master: master,
      setMaster: function(v){ master.gain.setTargetAtTime(v, ctx.currentTime, 0.05); },
      setMix: function(r,c){ rMix.gain.setTargetAtTime(r, ctx.currentTime, 0.05); cMix.gain.setTargetAtTime(c, ctx.currentTime, 0.05); },
      setRumble: function(base){ saw.frequency.setTargetAtTime(base, ctx.currentTime, 0.1); sine.frequency.setTargetAtTime(Math.max(10, base*0.55), ctx.currentTime, 0.1); },
      setPad: function(h1,h2,h3){ p1.frequency.setTargetAtTime(h1, ctx.currentTime, 0.15); p2.frequency.setTargetAtTime(h2, ctx.currentTime, 0.15); p3.frequency.setTargetAtTime(h3, ctx.currentTime, 0.15); }
    };
  }
  function startAudio(){
    var Ctx = window.AudioContext || window.webkitAudioContext;
    if (!Ctx){ setStatus('No Web Audio'); return; }
    if (!ac){ ac=new Ctx(); drone=makeDrone(ac); masterGain=drone.master; }
    ac.resume(); ui.btnMute.disabled=true; setStatus('Audio running'); log('Audio started');
    drone.setMaster(MASTER_VOL);
  }
  function toggleMute(){ if(!ac||!masterGain) return; muted=!muted; masterGain.gain.setTargetAtTime(muted?0:MASTER_VOL, ac.currentTime, 0.05); ui.btnMute.textContent=muted?'Unmute':'Mute'; }

  function tick(){
    maybeSwitchModes();
    if (mode==='ACCEL_LEAD'){
      v_fused = A_LEAD*v_acc + (1-A_LEAD)*v_fused;
      if (gpsSpeed!=null && lastFixAge<=FIX_STALE){ var soft=0.05; v_fused = (1-soft)*v_fused + soft*gpsSpeed; }
    } else {
      if (gpsSpeed!=null){ var fast=0.65; v_fused = (1-fast)*v_fused + fast*gpsSpeed; }
    }
    if (v_fused<0) v_fused=0;
    ui.v_fused.textContent=v_fused.toFixed(2);
    ui.v_fused_mph.textContent=(v_fused*2.236936).toFixed(2);

    if (ac && drone){
      var n = smoothstep(Math.min(1, v_fused/Math.max(0.1, VMAX)));
      drone.setMix((1-n)*RUMBLE_TRIM, n*CHORUS_TRIM);
      var keySemi = NOTE_NAMES.indexOf(ui.key.value);
      var baseHz = ui.quant.checked ? midiToHz(speedToMidiInScale(n, keySemi, ui.scale.value)) : 180 + 520*n;
      var ints = chordIntervals(ui.chord.value);
      drone.setPad(baseHz, baseHz*Math.pow(2,(ints[1]||7)/12), baseHz*Math.pow(2,(ints[2]||12)/12));
      drone.setRumble(30 + 70*n);
    }
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);

  // ----- bindings (single event per tap)
  bindTap(ui.btnMotion, function(){ enableMotion(); log('Enable Motion'); });
  bindTap(ui.btnGPS, function(){ startGPS(); log('Start GPS'); });
  bindTap(ui.btnStopGPS, function(){ stopGPS(); log('Stop GPS'); });
  bindTap(ui.btnAudio, function(){ startAudio(); log('Start Audio'); });
  bindTap(ui.btnMute, function(){ toggleMute(); log('Toggle Mute'); });
  bindTap(ui.btnAll, function(){ enableMotion(); startGPS(); startAudio(); log('Start All'); });
  bindTap(ui.btnReset, function(){
    v_acc=0; v_fused=0; emaHz=0; lastMotionT=null;
    gpsSpeed=null; lastFix=null; lastPos=null; anchorPos=null;
    distSinceAnchor=0; lastFixAge=Infinity;
    ui.v_acc.textContent='-'; ui.v_gps.textContent='-'; ui.v_fused.textContent='-'; ui.v_fused_mph.textContent='-';
    ui.hz.textContent='0'; ui.acc.textContent='-'; ui.fixAge.textContent='-'; ui.dist.textContent='0';
    mode='ACCEL_LEAD'; setStatus('Reset'); log('Reset');
  });

  if (location.protocol==='file:'){ log('Note: GPS may be blocked on file://; use http(s) if needed.'); }
})();
</script>
</body>
</html>

<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>M8 Web MIDI — 8ch Scale Sender</title>
    <style>
        :root {
            --bg: #0b0c0f;
            --panel: #101217;
            --panel2: #0e1014;
            --border: rgba(255, 255, 255, .08);
            --text: rgba(255, 255, 255, .88);
            --muted: rgba(255, 255, 255, .55);
            --accent: #8dfcff;
            --accent2: #a6ff9a;
            --danger: #ff6b8b;
            --shadow: 0 10px 30px rgba(0, 0, 0, .45);
            --radius: 14px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: radial-gradient(1200px 800px at 70% 10%, rgba(141, 252, 255, .08), transparent 60%),
                radial-gradient(900px 700px at 15% 80%, rgba(166, 255, 154, .06), transparent 55%),
                var(--bg);
            color: var(--text);
        }

        .app {
            max-width: 1100px;
            margin: 24px auto;
            padding: 0 16px 40px;
        }

        header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 16px;
            margin: 8px 0 18px;
        }

        h1 {
            margin: 0;
            font-size: 18px;
            letter-spacing: .3px;
            font-weight: 650;
        }

        .subtitle {
            color: var(--muted);
            font-size: 12px;
        }

        section {
            background: linear-gradient(180deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 14px;
            margin: 12px 0;
        }

        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 10px;
        }

        .section-title h2 {
            margin: 0;
            font-size: 13px;
            font-weight: 650;
            letter-spacing: .25px;
            color: rgba(255, 255, 255, .82);
        }

        .section-title .hint {
            font-size: 12px;
            color: var(--muted);
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .row>* {
            flex: 1 1 auto;
        }

        label {
            display: block;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        select,
        button {
            width: 100%;
            background: rgba(255, 255, 255, .03);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 12px;
            padding: 10px 10px;
            outline: none;
        }

        select:focus,
        button:focus {
            border-color: rgba(141, 252, 255, .35);
            box-shadow: 0 0 0 3px rgba(141, 252, 255, .10);
        }

        button {
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            border-color: rgba(255, 255, 255, .18);
        }

        button.primary {
            border-color: rgba(141, 252, 255, .25);
        }

        button.primary:hover {
            border-color: rgba(141, 252, 255, .45);
        }

        button.danger {
            border-color: rgba(255, 107, 139, .25);
        }

        button.danger:hover {
            border-color: rgba(255, 107, 139, .5);
        }

        .status {
            margin-top: 10px;
            font-size: 12px;
            color: var(--muted);
            line-height: 1.35;
        }

        .status strong {
            color: rgba(255, 255, 255, .85);
            font-weight: 650;
        }

        .status .ok {
            color: rgba(166, 255, 154, .9);
        }

        .status .bad {
            color: rgba(255, 107, 139, .9);
        }

        .tracks {
            display: grid;
            grid-template-columns: repeat(8, minmax(0, 1fr));
            gap: 10px;
        }

        .track {
            background: linear-gradient(180deg, rgba(0, 0, 0, .18), rgba(0, 0, 0, .05));
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 10px 10px 12px;
            min-height: 92px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .track .ch {
            font-size: 11px;
            color: var(--muted);
            letter-spacing: .25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .track .ch .dot {
            width: 8px;
            height: 8px;
            border-radius: 99px;
            background: rgba(255, 255, 255, .14);
            box-shadow: none;
        }

        .track.active .ch .dot {
            background: var(--accent);
            box-shadow: 0 0 16px rgba(141, 252, 255, .22);
        }

        .track .note {
            font-variant-numeric: tabular-nums;
            font-size: 28px;
            font-weight: 720;
            letter-spacing: .5px;
            color: rgba(255, 255, 255, .92);
            min-height: 34px;
            display: flex;
            align-items: flex-end;
        }

        .track .note.empty {
            color: rgba(255, 255, 255, .18);
            font-weight: 650;
        }

        .two {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 900px) {
            .tracks {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }

        @media (max-width: 560px) {
            .tracks {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .two {
                grid-template-columns: 1fr;
            }
        }

        .toggleRow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
        }

        .toggleWrap {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggleLabel {
            font-size: 13px;
            color: rgba(255, 255, 255, .82);
            font-weight: 650;
            letter-spacing: .25px;
        }

        .switch {
            position: relative;
            width: 56px;
            height: 32px;
            flex: 0 0 auto;
        }

        .switch input {
            appearance: none;
            -webkit-appearance: none;
            width: 56px;
            height: 32px;
            background: rgba(255, 255, 255, .05);
            border: 1px solid var(--border);
            border-radius: 999px;
            outline: none;
            cursor: pointer;
            transition: background .15s, border-color .15s;
        }

        .switch input::before {
            content: "";
            position: absolute;
            top: 5px;
            left: 6px;
            width: 22px;
            height: 22px;
            border-radius: 999px;
            background: rgba(255, 255, 255, .75);
            transition: transform .18s ease, background .15s;
            box-shadow: 0 8px 18px rgba(0, 0, 0, .35);
        }

        .switch input:checked {
            background: rgba(141, 252, 255, .12);
            border-color: rgba(141, 252, 255, .35);
        }

        .switch input:checked::before {
            transform: translateX(22px);
            background: var(--accent);
            box-shadow: 0 0 18px rgba(141, 252, 255, .20), 0 8px 18px rgba(0, 0, 0, .35);
        }

        .smallActions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .smallActions button {
            width: auto;
            min-width: 160px;
        }

        hr.sep {
            border: none;
            border-top: 1px solid rgba(255, 255, 255, .06);
            margin: 10px 0 0;
        }
    </style>
</head>

<body>
    <div class="app">
        <header>
            <div>
                <h1>M8 Web MIDI — 8-Track Scale Sender</h1>
                <div class="subtitle">Pick an output device (M8), choose root + scale, toggle output to send notes on
                    channels 1–8.</div>
            </div>
            <div class="subtitle" id="supportNote"></div>
        </header>

        <section>
            <div class="section-title">
                <h2>1) MIDI Output Device</h2>
                <div class="hint">You must grant MIDI access once per page load.</div>
            </div>

            <div class="row" style="align-items:flex-end;">
                <div style="flex:2 1 280px;">
                    <label for="outSelect">Output</label>
                    <select id="outSelect" disabled>
                        <option value="">(connect first)</option>
                    </select>
                </div>

                <div style="flex:1 1 220px;">
                    <label>&nbsp;</label>
                    <button id="btnConnect" class="primary">Connect MIDI</button>
                </div>

                <div style="flex:1 1 220px;">
                    <label>&nbsp;</label>
                    <button id="btnPanic" class="danger" disabled>Panic (All Notes Off)</button>
                </div>
            </div>

            <div class="status" id="midiStatus">
                <strong>Status:</strong> <span class="bad">Not connected.</span>
            </div>
        </section>

        <section>
            <div class="section-title">
                <h2>2) Track Visualization</h2>
                <div class="hint">Shows the target note number per channel (1–8). Pitch slides over 3s when it changes.
                </div>
            </div>

            <div class="tracks" id="tracks"></div>
        </section>

        <section>
            <div class="section-title">
                <h2>3) Root Note + Scale</h2>
                <div class="hint">Changing these while output is ON will slide pitches (no Note Off/On).</div>
            </div>

            <div class="two">
                <div>
                    <label for="rootSelect">Root note</label>
                    <select id="rootSelect" disabled></select>
                </div>
                <div>
                    <label for="scaleSelect">Scale / mode</label>
                    <select id="scaleSelect" disabled></select>
                </div>
            </div>
        </section>

        <section>
            <div class="section-title">
                <h2>4) Output</h2>
                <div class="hint">Toggle ON sends Note On. Toggle OFF sends Note Off. Root/scale changes only send Pitch
                    Bend ramps.</div>
            </div>

            <div class="toggleRow">
                <div class="toggleWrap">
                    <div class="switch">
                        <input id="outputToggle" type="checkbox" disabled />
                    </div>
                    <div class="toggleLabel" id="toggleLabel">Output OFF</div>
                </div>

                <div class="smallActions">
                    <button id="btnResend" disabled>Resend Notes</button>
                </div>
            </div>

            <hr class="sep" />
            <div class="status" id="notePlan">
                <strong>Planned notes:</strong> —
            </div>
        </section>
    </div>

    <script>
		// ----------------------------
		// MIDI + Music helpers
		// ----------------------------
		const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

		const SCALES = [
			{ name: "Major (Ionian)", offsets: [0,2,4,5,7,9,11] },
			{ name: "Natural Minor (Aeolian)", offsets: [0,2,3,5,7,8,10] },
			{ name: "Dorian", offsets: [0,2,3,5,7,9,10] },
			{ name: "Phrygian", offsets: [0,1,3,5,7,8,10] },
			{ name: "Lydian", offsets: [0,2,4,6,7,9,11] },
			{ name: "Mixolydian", offsets: [0,2,4,5,7,9,10] },
			{ name: "Locrian", offsets: [0,1,3,5,6,8,10] },
			{ name: "Pentatonic Major", offsets: [0,2,4,7,9] },
			{ name: "Pentatonic Minor", offsets: [0,3,5,7,10] },
		];

		function midiToName(n){
			const name = NOTE_NAMES[n % 12];
			const oct = Math.floor(n / 12) - 1;
			return `${name}${oct}`;
		}

		function buildScaleNotes(rootMidi, offsets, count){
			const m = offsets.length;
			const notes = [];
			for(let i=0;i<count;i++){
				const degree = i % m;
				const oct = Math.floor(i / m);
				notes.push(rootMidi + offsets[degree] + 12 * oct);
			}
			return notes;
		}

		// ----------------------------
		// Portamento / Pitch Bend setup
		// ----------------------------
		const SLIDE_MS = 3000;

		// Pitch Bend range (in semitones). We also *try* to set this via RPN on channels 1–8.
		// 48 gives you ±4 octaves of slide room.
		const PB_RANGE_SEMIS = 48;

		// ----------------------------
		// App state
		// ----------------------------
		let midiAccess = null;
		let currentOutput = null;
		let currentOutputId = "";
		let enabled = false;

		// Per-channel state (channels 1..8)
		const chState = Array.from({length: 8}, () => ({
			baseNote: -1,			// the actual Note On note number we are holding
			targetNote: -1,			// the conceptual note we want (shown in UI)
			bendSemis: 0,			// current pitch bend offset in semitones relative to baseNote
			slideRaf: 0,			// requestAnimationFrame id
			slideFrom: 0,
			slideTo: 0,
			slideStartT: 0,
		}));

		// Planned target notes from UI (always length 8)
		let plannedNotes = Array(8).fill(-1);

		const els = {
			supportNote: document.getElementById("supportNote"),
			outSelect: document.getElementById("outSelect"),
			btnConnect: document.getElementById("btnConnect"),
			btnPanic: document.getElementById("btnPanic"),
			midiStatus: document.getElementById("midiStatus"),

			tracks: document.getElementById("tracks"),

			rootSelect: document.getElementById("rootSelect"),
			scaleSelect: document.getElementById("scaleSelect"),

			outputToggle: document.getElementById("outputToggle"),
			toggleLabel: document.getElementById("toggleLabel"),
			btnResend: document.getElementById("btnResend"),

			notePlan: document.getElementById("notePlan"),
		};

		// ----------------------------
		// UI init
		// ----------------------------
		function initTracksUI(){
			els.tracks.innerHTML = "";
			for(let ch=1; ch<=8; ch++){
				const card = document.createElement("div");
				card.className = "track";
				card.dataset.ch = String(ch);

				const top = document.createElement("div");
				top.className = "ch";
				top.innerHTML = `<span>CH ${ch}</span><span class="dot" aria-hidden="true"></span>`;

				const note = document.createElement("div");
				note.className = "note empty";
				note.textContent = "—";
				note.dataset.role = "note";

				card.appendChild(top);
				card.appendChild(note);
				els.tracks.appendChild(card);
			}
			renderTracks();
		}

		function renderTracks(){
			for(let i=0;i<8;i++){
				const ch = i + 1;
				const card = els.tracks.querySelector(`.track[data-ch="${ch}"]`);
				const noteEl = card.querySelector(`[data-role="note"]`);

				const active = chState[i].baseNote >= 0;
				const shown = chState[i].targetNote;

				if(active){
					card.classList.add("active");
					noteEl.classList.remove("empty");
					noteEl.textContent = (shown >= 0) ? String(shown) : "—";
				}else{
					card.classList.remove("active");
					noteEl.classList.add("empty");
					noteEl.textContent = "—";
				}
			}
		}

		function setStatus(html){
			els.midiStatus.innerHTML = `<strong>Status:</strong> ${html}`;
		}

		function setEnabledUI(canUse){
			els.outSelect.disabled = !canUse;
			els.rootSelect.disabled = !canUse;
			els.scaleSelect.disabled = !canUse;
			els.outputToggle.disabled = !canUse || !currentOutput;
			els.btnPanic.disabled = !canUse || !currentOutput;
			els.btnResend.disabled = !canUse || !currentOutput;
		}

		function updateToggleLabel(){
			els.toggleLabel.textContent = enabled ? "Output ON" : "Output OFF";
		}

		function updateNotePlanText(){
			const parts = plannedNotes.map((n,i)=> `CH${i+1}:${n>=0? n : "—"}`);
			const root = Number(els.rootSelect.value || 60);
			const scale = SCALES[Number(els.scaleSelect.value || 0)];
			els.notePlan.innerHTML =
				`<strong>Planned notes:</strong> ${parts.join("  •  ")} ` +
				`<span style="color:rgba(255,255,255,.45);">(${midiToName(root)} / ${scale.name})</span>`;
		}

		function populateRootSelect(){
			els.rootSelect.innerHTML = "";
			for(let n=24; n<=96; n++){
				const opt = document.createElement("option");
				opt.value = String(n);
				opt.textContent = `${midiToName(n)} (${n})`;
				els.rootSelect.appendChild(opt);
			}
			els.rootSelect.value = "60";
		}

		function populateScaleSelect(){
			els.scaleSelect.innerHTML = "";
			SCALES.forEach((s, idx)=>{
				const opt = document.createElement("option");
				opt.value = String(idx);
				opt.textContent = s.name;
				els.scaleSelect.appendChild(opt);
			});
			els.scaleSelect.value = "0";
		}

		// ----------------------------
		// MIDI send helpers
		// ----------------------------
		function sendCC(ch1, cc, val){
			if(!currentOutput) return;
			const ch0 = Math.max(0, Math.min(15, ch1 - 1));
			currentOutput.send([0xB0 + ch0, cc & 0x7F, val & 0x7F]);
		}

		function sendNoteOn(ch1, note, vel=96){
			if(!currentOutput) return;
			const ch0 = Math.max(0, Math.min(15, ch1 - 1));
			currentOutput.send([0x90 + ch0, note & 0x7F, vel & 0x7F]);
		}

		function sendNoteOff(ch1, note){
			if(!currentOutput) return;
			const ch0 = Math.max(0, Math.min(15, ch1 - 1));
			currentOutput.send([0x80 + ch0, note & 0x7F, 0x00]);
		}

		function sendPitchBend14(ch1, value14){
			if(!currentOutput) return;
			const v = Math.max(0, Math.min(16383, value14|0));
			const lsb = v & 0x7F;
			const msb = (v >> 7) & 0x7F;
			const ch0 = Math.max(0, Math.min(15, ch1 - 1));
			currentOutput.send([0xE0 + ch0, lsb, msb]);
		}

		function sendPitchBendSemis(ch1, semis){
			// Map semitones to 14-bit pitch bend with configured range.
			// Center = 8192, full up = +PB_RANGE_SEMIS, full down = -PB_RANGE_SEMIS
			const clamped = Math.max(-PB_RANGE_SEMIS, Math.min(PB_RANGE_SEMIS, semis));
			const v = Math.round(8192 + (clamped / PB_RANGE_SEMIS) * 8192);
			sendPitchBend14(ch1, v);
		}

		function sendPitchBendCenter(ch1){
			sendPitchBend14(ch1, 8192);
		}

		function setPitchBendRangeRPN(ch1, semis){
			// RPN 0,0 = Pitch Bend Sensitivity
			// Data Entry MSB (CC6) = semitones, LSB (CC38) = cents
			sendCC(ch1, 101, 0);	// RPN MSB
			sendCC(ch1, 100, 0);	// RPN LSB
			sendCC(ch1, 6, Math.max(0, Math.min(127, semis|0)));
			sendCC(ch1, 38, 0);
			// RPN Null
			sendCC(ch1, 101, 127);
			sendCC(ch1, 100, 127);
		}

		function sendAllNotesOff(){
			if(!currentOutput) return;
			for(let ch1=1; ch1<=16; ch1++){
				// CC 123 = All Notes Off, CC 120 = All Sound Off
				sendCC(ch1, 123, 0);
				sendCC(ch1, 120, 0);
				sendPitchBendCenter(ch1);
			}
		}

		// ----------------------------
		// Sliding logic (per channel)
		// ----------------------------
		function cancelSlide(i){
			const st = chState[i];
			if(st.slideRaf){
				cancelAnimationFrame(st.slideRaf);
				st.slideRaf = 0;
			}
		}

		function slideChannelToTarget(i, newTargetNote){
			const st = chState[i];
			const ch1 = i + 1;

			if(!enabled || !currentOutput) return;
			if(st.baseNote < 0) return;

			// current bend is st.bendSemis; we want bend so baseNote + bend == newTargetNote
			const from = st.bendSemis;
			const to = (newTargetNote - st.baseNote);

			st.targetNote = newTargetNote; // UI target changes immediately
			renderTracks();

			// Restart slide from current position
			cancelSlide(i);
			st.slideFrom = from;
			st.slideTo = to;
			st.slideStartT = performance.now();

			const tick = (t)=>{
				if(!enabled || !currentOutput){
					st.slideRaf = 0;
					return;
				}
				const u = Math.min(1, (t - st.slideStartT) / SLIDE_MS);
				const bend = st.slideFrom + (st.slideTo - st.slideFrom) * u;

				st.bendSemis = bend;
				sendPitchBendSemis(ch1, bend);

				if(u < 1){
					st.slideRaf = requestAnimationFrame(tick);
				}else{
					st.slideRaf = 0;
				}
			};

			st.slideRaf = requestAnimationFrame(tick);
		}

		// ----------------------------
		// Note planning + applying
		// ----------------------------
		function computePlannedNotes(){
			const root = Number(els.rootSelect.value || 60);
			const scale = SCALES[Number(els.scaleSelect.value || 0)];
			const notes = buildScaleNotes(root, scale.offsets, 8);
			plannedNotes = notes.map(n => Math.max(0, Math.min(127, n)));
			updateNotePlanText();
		}

		function applyTargets(){
			// Update planned target notes and (if enabled) slide toward them.
			computePlannedNotes();

			// Update target notes always (so UI stays current)
			for(let i=0;i<8;i++){
				chState[i].targetNote = plannedNotes[i];
			}
			renderTracks();

			// If output is ON, slide instead of Note Off/On
			if(!enabled || !currentOutput) return;

			for(let i=0;i<8;i++){
				slideChannelToTarget(i, plannedNotes[i]);
			}
		}

		function startOutput(){
			if(!currentOutput) return;

			computePlannedNotes();

			// Try to set pitch bend range for channels 1..8 (so slides can span wider intervals)
			for(let ch1=1; ch1<=8; ch1++){
				setPitchBendRangeRPN(ch1, PB_RANGE_SEMIS);
				sendPitchBendCenter(ch1);
			}

			// Start one held note per channel, at the *current planned note* as the base note.
			for(let i=0;i<8;i++){
				cancelSlide(i);
				const ch1 = i + 1;
				const n = plannedNotes[i];

				chState[i].baseNote = n;
				chState[i].targetNote = n;
				chState[i].bendSemis = 0;

				sendPitchBendCenter(ch1);
				sendNoteOn(ch1, n, 96);
			}

			renderTracks();
		}

		function stopOutput(){
			// Stop slides, send Note Off for base notes, reset bend, safety CCs
			for(let i=0;i<8;i++){
				cancelSlide(i);
				const ch1 = i + 1;
				const st = chState[i];

				if(st.baseNote >= 0){
					sendNoteOff(ch1, st.baseNote);
				}
				sendPitchBendCenter(ch1);

				st.baseNote = -1;
				st.targetNote = -1;
				st.bendSemis = 0;
			}

			sendAllNotesOff();
			renderTracks();
		}

		// ----------------------------
		// MIDI device management
		// ----------------------------
		function refreshOutputList(){
			const prev = currentOutputId;

			els.outSelect.innerHTML = "";
			const placeholder = document.createElement("option");
			placeholder.value = "";
			placeholder.textContent = "(select an output device)";
			els.outSelect.appendChild(placeholder);

			if(!midiAccess) return;

			const outputs = Array.from(midiAccess.outputs.values());
			outputs.sort((a,b)=> (a.name||"").localeCompare(b.name||""));

			for(const out of outputs){
				const opt = document.createElement("option");
				opt.value = out.id;
				opt.textContent = `${out.name || "Unnamed"}${out.manufacturer ? " — " + out.manufacturer : ""}`;
				els.outSelect.appendChild(opt);
			}

			if(prev && outputs.some(o=>o.id === prev)){
				els.outSelect.value = prev;
				selectOutput(prev, {silent:true});
			}else{
				els.outSelect.value = "";
				selectOutput("", {silent:true});
			}
		}

		function selectOutput(id, {silent=false}={}){
			// If switching while enabled, stop old output cleanly.
			if(enabled && currentOutput){
				stopOutput();
			}

			currentOutputId = id || "";
			currentOutput = null;

			if(midiAccess && id){
				currentOutput = midiAccess.outputs.get(id) || null;
			}

			setEnabledUI(!!midiAccess);

			if(!silent){
				if(currentOutput){
					setStatus(
						`<span class="ok">Connected.</span> Output: <strong>${currentOutput.name || "Unnamed"}</strong>` +
						` <span style="color:rgba(255,255,255,.45);">| PB range: ±${PB_RANGE_SEMIS} semis</span>`
					);
				}else{
					setStatus(`<span class="bad">Connected, but no output selected.</span>`);
				}
			}

			// If output toggle is ON (shouldn’t be, but just in case), restart
			if(enabled && currentOutput){
				startOutput();
			}
		}

		// ----------------------------
		// Events
		// ----------------------------
		async function connectMIDI(){
			if(!navigator.requestMIDIAccess){
				els.supportNote.textContent = "Web MIDI not supported in this browser.";
				setStatus(`<span class="bad">Web MIDI not supported.</span> Try Chrome or Edge.`);
				return;
			}

			try{
				midiAccess = await navigator.requestMIDIAccess({ sysex: false });
				midiAccess.onstatechange = () => refreshOutputList();

				refreshOutputList();
				setEnabledUI(true);

				setStatus(`<span class="ok">Connected.</span> Select your M8 from the Output list.`);
			}catch(err){
				setStatus(`<span class="bad">Permission denied or unavailable.</span> ${String(err)}`);
			}
		}

		els.btnConnect.addEventListener("click", async ()=>{
			await connectMIDI();
		});

		els.outSelect.addEventListener("change", ()=>{
			selectOutput(els.outSelect.value);
		});

		els.rootSelect.addEventListener("change", ()=>{
			applyTargets(); // slides (if enabled)
		});

		els.scaleSelect.addEventListener("change", ()=>{
			applyTargets(); // slides (if enabled)
		});

		els.outputToggle.addEventListener("change", ()=>{
			const wantOn = els.outputToggle.checked;

			if(wantOn){
				if(!currentOutput){
					els.outputToggle.checked = false;
					enabled = false;
					updateToggleLabel();
					setStatus(`<span class="bad">Select an output first.</span>`);
					return;
				}

				enabled = true;
				updateToggleLabel();
				startOutput();
				setStatus(
					`<span class="ok">Output ON.</span> Notes held on channels 1–8; pitch slides over ${Math.round(SLIDE_MS/1000)}s on changes.`
				);
			}else{
				enabled = false;
				updateToggleLabel();
				stopOutput();
				setStatus(`<span class="ok">Output OFF.</span> Notes released.`);
			}
		});

		els.btnPanic.addEventListener("click", ()=>{
			// Don’t change enabled state; just nuke everything.
			for(let i=0;i<8;i++) cancelSlide(i);
			sendAllNotesOff();
			for(let i=0;i<8;i++){
				chState[i].baseNote = -1;
				chState[i].targetNote = -1;
				chState[i].bendSemis = 0;
			}
			renderTracks();
			setStatus(`<span class="ok">Panic sent.</span> All Notes Off / All Sound Off.`);
		});

		els.btnResend.addEventListener("click", ()=>{
			if(!currentOutput){
				setStatus(`<span class="bad">No output selected.</span>`);
				return;
			}
			if(enabled){
				stopOutput();
				startOutput();
				setStatus(`<span class="ok">Resent notes.</span>`);
			}else{
				setStatus(`<span class="ok">Ready.</span> Turn Output ON to send notes.`);
			}
		});

		// ----------------------------
		// Boot
		// ----------------------------
		(function boot(){
			initTracksUI();
			populateRootSelect();
			populateScaleSelect();
			computePlannedNotes();

			const supported = !!navigator.requestMIDIAccess;
			els.supportNote.textContent = supported ? "Web MIDI supported" : "Web MIDI NOT supported";
			setEnabledUI(false);
			updateToggleLabel();

			// Keep target notes visible only when active; so default is blank.
			for(let i=0;i<8;i++){
				chState[i].baseNote = -1;
				chState[i].targetNote = -1;
			}
			renderTracks();

			if(!supported){
				setStatus(`<span class="bad">Web MIDI not supported.</span> Use Chrome/Edge, and run from https:// or localhost.`);
			}else{
				setStatus(`<span class="bad">Not connected.</span> Click <strong>Connect MIDI</strong>.`);
			}
		})();
    </script>
</body>

</html>
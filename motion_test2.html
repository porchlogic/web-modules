<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Accelerometer Visualizer + Cumulative Sum</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        :root {
            --bg: #0b0b10;
            --panel: #161623;
            --accent: #4da3ff;
            --accent-soft: #294366;
            --text: #f5f5ff;
            --text-muted: #a0a4c0;
            --danger: #ff6b6b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            padding: 1rem;
        }

        h1 {
            font-size: 1.3rem;
            margin: 0 0 0.5rem;
        }

        p {
            margin-top: 0;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .panel {
            background: var(--panel);
            border-radius: 0.75rem;
            padding: 0.85rem;
            margin-top: 0.75rem;
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.35);
        }

        .button-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        button {
            padding: 0.65rem 0.8rem;
            border-radius: 0.5rem;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            background: var(--accent);
            color: #fff;
        }

        button.secondary {
            background: #333649;
        }

        button.small {
            font-size: 0.8rem;
            padding: 0.45rem 0.6rem;
        }

        button:disabled {
            opacity: 0.4;
            cursor: default;
        }

        .status {
            margin-top: 0.4rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .status.error {
            color: var(--danger);
        }

        .bars {
            margin-top: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .bar-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .bar-label {
            width: 1.4rem;
        }

        .bar-container {
            flex: 1;
            height: 0.75rem;
            border-radius: 999px;
            background: #11121b;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 0;
            transform-origin: left center;
            background: linear-gradient(90deg, var(--accent-soft), var(--accent));
        }

        .bar-zero-line {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 1px;
            background: rgba(255, 255, 255, 0.2);
        }

        .bar-value {
            width: 4.2rem;
            text-align: right;
            font-variant-numeric: tabular-nums;
            color: var(--text-muted);
        }

        .slider-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        input[type="range"] {
            flex: 1;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.15rem;
        }

        .metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 0.75rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .metric {
            min-width: 8rem;
        }

        .metric strong {
            display: block;
            color: var(--text);
            font-size: 0.85rem;
        }

        .cumulative-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.4rem 0.9rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        .cumulative-grid div strong {
            display: inline-block;
            min-width: 2rem;
        }

        .cumulative-grid div span {
            font-variant-numeric: tabular-nums;
            color: var(--text-muted);
            margin-left: 0.25rem;
        }
    </style>
</head>

<body>
    <h1>Accelerometer Visualizer</h1>
    <p>
        Live accelerometer bars with adjustable smoothing, plus a cumulative sum
        (integrated acceleration) so you can see drift build up over time.
    </p>

    <div class="panel">
        <div class="button-row">
            <button id="enableBtn">Enable Motion</button>
            <button id="stopBtn" class="secondary" disabled>Stop</button>
            <button id="resetCumBtn" class="secondary small" disabled>Reset cumulative</button>
        </div>
        <div id="status" class="status">Waiting to start…</div>

        <div style="margin-top:0.9rem;">
            <div class="slider-row">
                <span>Smoothing</span>
                <input id="smoothSlider" type="range" min="0" max="100" value="30" />
                <span id="smoothLabel">0.30</span>
            </div>
            <div class="slider-labels">
                <span>Raw</span>
                <span>Smoothed</span>
            </div>
        </div>

        <div class="bars">
            <div class="bar-row">
                <div class="bar-label">X</div>
                <div class="bar-container">
                    <div class="bar-zero-line"></div>
                    <div id="barX" class="bar-fill"></div>
                </div>
                <div id="valX" class="bar-value">0.00</div>
            </div>
            <div class="bar-row">
                <div class="bar-label">Y</div>
                <div class="bar-container">
                    <div class="bar-zero-line"></div>
                    <div id="barY" class="bar-fill"></div>
                </div>
                <div id="valY" class="bar-value">0.00</div>
            </div>
            <div class="bar-row">
                <div class="bar-label">Z</div>
                <div class="bar-container">
                    <div class="bar-zero-line"></div>
                    <div id="barZ" class="bar-fill"></div>
                </div>
                <div id="valZ" class="bar-value">0.00</div>
            </div>
            <div class="bar-row">
                <div class="bar-label">‖a‖</div>
                <div class="bar-container">
                    <div class="bar-zero-line"></div>
                    <div id="barMag" class="bar-fill"></div>
                </div>
                <div id="valMag" class="bar-value">0.00</div>
            </div>
        </div>

        <div class="metrics">
            <div class="metric">
                <strong>Samples</strong>
                <span id="sampleCount">0</span>
            </div>
            <div class="metric">
                <strong>Last update</strong>
                <span id="lastUpdate">–</span>
            </div>
            <div class="metric">
                <strong>Approx. rate</strong>
                <span id="rate">– Hz</span>
            </div>
        </div>

        <div
            style="margin-top:0.8rem; font-size:0.85rem; display:flex; justify-content:space-between; align-items:center;">
            <span>Cumulative (∫ a dt, using smoothed values)</span>
        </div>
        <div class="cumulative-grid">
            <div><strong>X:</strong><span id="cumX">0.00</span> m/s</div>
            <div><strong>Y:</strong><span id="cumY">0.00</span> m/s</div>
            <div><strong>Z:</strong><span id="cumZ">0.00</span> m/s</div>
            <div><strong>‖a‖:</strong><span id="cumMag">0.00</span> (unit-ish)</div>
        </div>
    </div>

    <script>
		let listening = false;
		let raw = { x: 0, y: 0, z: 0, mag: 0 };
		let smooth = { x: 0, y: 0, z: 0, mag: 0 };
		let alpha = 0.3; // smoothing factor (0 = raw, 0.95 = heavy smoothing)

		let lastTimestamp = null;
		let sampleCount = 0;
		let startTime = null;

		// Cumulative integral (approx velocity-like, in m/s)
		let cumulative = { x: 0, y: 0, z: 0, mag: 0 };
		let lastIntegrateTs = null;

		const enableBtn = document.getElementById("enableBtn");
		const stopBtn = document.getElementById("stopBtn");
		const resetCumBtn = document.getElementById("resetCumBtn");
		const statusEl = document.getElementById("status");
		const slider = document.getElementById("smoothSlider");
		const sliderLabel = document.getElementById("smoothLabel");

		const barX = document.getElementById("barX");
		const barY = document.getElementById("barY");
		const barZ = document.getElementById("barZ");
		const barMag = document.getElementById("barMag");

		const valX = document.getElementById("valX");
		const valY = document.getElementById("valY");
		const valZ = document.getElementById("valZ");
		const valMag = document.getElementById("valMag");

		const sampleCountEl = document.getElementById("sampleCount");
		const lastUpdateEl = document.getElementById("lastUpdate");
		const rateEl = document.getElementById("rate");

		const cumXEl = document.getElementById("cumX");
		const cumYEl = document.getElementById("cumY");
		const cumZEl = document.getElementById("cumZ");
		const cumMagEl = document.getElementById("cumMag");

		// Map slider [0,100] → alpha [0,0.95]
		function updateAlphaFromSlider() {
			const v = parseInt(slider.value, 10) / 100; // 0..1
			alpha = 0.95 * v;
			sliderLabel.textContent = alpha.toFixed(2);
		}
		updateAlphaFromSlider();
		slider.addEventListener("input", updateAlphaFromSlider);

		function formatTime(ts) {
			const d = new Date(ts);
			return d.toLocaleTimeString();
		}

		function resetCumulative() {
			cumulative.x = 0;
			cumulative.y = 0;
			cumulative.z = 0;
			cumulative.mag = 0;
			lastIntegrateTs = null;
		}

		function handleMotion(event) {
			const acc = event.acceleration || event.accelerationIncludingGravity;
			if (!acc) return;

			const ts = event.timeStamp || performance.now();
			const ax = acc.x || 0;
			const ay = acc.y || 0;
			const az = acc.z || 0;
			const mag = Math.sqrt(ax*ax + ay*ay + az*az);

			raw.x = ax;
			raw.y = ay;
			raw.z = az;
			raw.mag = mag;

			// One-pole IIR low-pass: smooth = alpha * smooth + (1-alpha) * raw
			smooth.x = alpha * smooth.x + (1 - alpha) * raw.x;
			smooth.y = alpha * smooth.y + (1 - alpha) * raw.y;
			smooth.z = alpha * smooth.z + (1 - alpha) * raw.z;
			smooth.mag = alpha * smooth.mag + (1 - alpha) * raw.mag;

			// Approximate integration of smoothed values to show drift
			if (lastIntegrateTs != null) {
				const dt = (ts - lastIntegrateTs) / 1000; // seconds
				// In ideal physics, ∫a dt = Δv. Here we just want to see how large it drifts.
				cumulative.x += smooth.x * dt;
				cumulative.y += smooth.y * dt;
				cumulative.z += smooth.z * dt;
				cumulative.mag += smooth.mag * dt;
			}
			lastIntegrateTs = ts;

			sampleCount++;
			if (!startTime) startTime = ts;

			lastTimestamp = ts;
		}

		function startListening() {
			if (listening) return;

			sampleCount = 0;
			startTime = null;
			lastTimestamp = null;
			resetCumulative();

			// iOS 13+ requires explicit permission
			if (typeof DeviceMotionEvent !== "undefined" &&
				typeof DeviceMotionEvent.requestPermission === "function") {
				DeviceMotionEvent.requestPermission()
					.then(response => {
						if (response === "granted") {
							window.addEventListener("devicemotion", handleMotion);
							listening = true;
							statusEl.textContent = "Motion capture enabled.";
							statusEl.classList.remove("error");
							enableBtn.disabled = true;
							stopBtn.disabled = false;
							resetCumBtn.disabled = false;
						} else {
							statusEl.textContent = "Permission denied.";
							statusEl.classList.add("error");
						}
					})
					.catch(err => {
						statusEl.textContent = "Permission error: " + err;
						statusEl.classList.add("error");
					});
			} else if ("DeviceMotionEvent" in window) {
				window.addEventListener("devicemotion", handleMotion);
				listening = true;
				statusEl.textContent = "Motion capture enabled.";
				statusEl.classList.remove("error");
				enableBtn.disabled = true;
				stopBtn.disabled = false;
				resetCumBtn.disabled = false;
			} else {
				statusEl.textContent = "DeviceMotion not supported on this device.";
				statusEl.classList.add("error");
			}
		}

		function stopListening() {
			if (!listening) return;
			window.removeEventListener("devicemotion", handleMotion);
			listening = false;
			statusEl.textContent = "Stopped.";
			enableBtn.disabled = false;
			stopBtn.disabled = true;
			resetCumBtn.disabled = true;
		}

		enableBtn.addEventListener("click", startListening);
		stopBtn.addEventListener("click", stopListening);
		resetCumBtn.addEventListener("click", resetCumulative);

		// Render loop: separate sensor and UI timing
		const MAX_ACCEL = 20; // m/s² for scaling bars (approx ±2g)
		function render() {
			const ax = smooth.x;
			const ay = smooth.y;
			const az = smooth.z;
			const mag = smooth.mag;

			// Clamp for visualization
			function clamp(v, max) {
				return Math.max(-max, Math.min(max, v));
			}
			const cx = clamp(ax, MAX_ACCEL);
			const cy = clamp(ay, MAX_ACCEL);
			const cz = clamp(az, MAX_ACCEL);
			const cm = clamp(mag, MAX_ACCEL);

			function updateBar(barElement, value) {
				const frac = Math.abs(value) / MAX_ACCEL; // 0..1
				barElement.style.width = (frac * 50) + "%"; // half bar left, half right
				barElement.style.transform = `translateX(${value >= 0 ? 0 : -100}%)`;
			}

			updateBar(barX, cx);
			updateBar(barY, cy);
			updateBar(barZ, cz);
			updateBar(barMag, cm);

			valX.textContent = ax.toFixed(2);
			valY.textContent = ay.toFixed(2);
			valZ.textContent = az.toFixed(2);
			valMag.textContent = mag.toFixed(2);

			sampleCountEl.textContent = sampleCount.toString();
			if (lastTimestamp != null) {
				lastUpdateEl.textContent = formatTime(Date.now());
			} else {
				lastUpdateEl.textContent = "–";
			}
			if (startTime && lastTimestamp && sampleCount > 1) {
				const dt = (lastTimestamp - startTime) / 1000;
				const hz = dt > 0 ? sampleCount / dt : 0;
				rateEl.textContent = hz.toFixed(1) + " Hz";
			} else {
				rateEl.textContent = "– Hz";
			}

			// Update cumulative display
			cumXEl.textContent = cumulative.x.toFixed(2);
			cumYEl.textContent = cumulative.y.toFixed(2);
			cumZEl.textContent = cumulative.z.toFixed(2);
			cumMagEl.textContent = cumulative.mag.toFixed(2);

			requestAnimationFrame(render);
		}
		requestAnimationFrame(render);
    </script>
</body>

</html>
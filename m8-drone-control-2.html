<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>M8 Web MIDI — 8ch Scale Sender</title>
    <style>
        :root {
            --bg: #0b0c0f;
            --panel: #101217;
            --panel2: #0e1014;
            --border: rgba(255, 255, 255, .08);
            --text: rgba(255, 255, 255, .88);
            --muted: rgba(255, 255, 255, .55);
            --accent: #8dfcff;
            /* subtle neon */
            --accent2: #a6ff9a;
            /* subtle neon alt */
            --danger: #ff6b8b;
            --shadow: 0 10px 30px rgba(0, 0, 0, .45);
            --radius: 14px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: radial-gradient(1200px 800px at 70% 10%, rgba(141, 252, 255, .08), transparent 60%),
                radial-gradient(900px 700px at 15% 80%, rgba(166, 255, 154, .06), transparent 55%),
                var(--bg);
            color: var(--text);
        }

        .app {
            max-width: 1100px;
            margin: 24px auto;
            padding: 0 16px 40px;
        }

        header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 16px;
            margin: 8px 0 18px;
        }

        h1 {
            margin: 0;
            font-size: 18px;
            letter-spacing: .3px;
            font-weight: 650;
        }

        .subtitle {
            color: var(--muted);
            font-size: 12px;
        }

        section {
            background: linear-gradient(180deg, rgba(255, 255, 255, .03), rgba(255, 255, 255, .01));
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 14px;
            margin: 12px 0;
        }

        .section-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 10px;
        }

        .section-title h2 {
            margin: 0;
            font-size: 13px;
            font-weight: 650;
            letter-spacing: .25px;
            color: rgba(255, 255, 255, .82);
        }

        .section-title .hint {
            font-size: 12px;
            color: var(--muted);
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .row>* {
            flex: 1 1 auto;
        }

        label {
            display: block;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 6px;
        }

        select,
        button {
            width: 100%;
            background: rgba(255, 255, 255, .03);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 12px;
            padding: 10px 10px;
            outline: none;
        }

        select:focus,
        button:focus {
            border-color: rgba(141, 252, 255, .35);
            box-shadow: 0 0 0 3px rgba(141, 252, 255, .10);
        }

        button {
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            border-color: rgba(255, 255, 255, .18);
        }

        button.primary {
            border-color: rgba(141, 252, 255, .25);
        }

        button.primary:hover {
            border-color: rgba(141, 252, 255, .45);
        }

        button.danger {
            border-color: rgba(255, 107, 139, .25);
        }

        button.danger:hover {
            border-color: rgba(255, 107, 139, .5);
        }

        .status {
            margin-top: 10px;
            font-size: 12px;
            color: var(--muted);
            line-height: 1.35;
        }

        .status strong {
            color: rgba(255, 255, 255, .85);
            font-weight: 650;
        }

        .status .ok {
            color: rgba(166, 255, 154, .9);
        }

        .status .bad {
            color: rgba(255, 107, 139, .9);
        }

        /* 8 track visualization */
        .tracks {
            display: grid;
            grid-template-columns: repeat(8, minmax(0, 1fr));
            gap: 10px;
        }

        .track {
            background: linear-gradient(180deg, rgba(0, 0, 0, .18), rgba(0, 0, 0, .05));
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 10px 10px 12px;
            min-height: 92px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .track .ch {
            font-size: 11px;
            color: var(--muted);
            letter-spacing: .25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .track .ch .dot {
            width: 8px;
            height: 8px;
            border-radius: 99px;
            background: rgba(255, 255, 255, .14);
            box-shadow: none;
        }

        .track.active .ch .dot {
            background: var(--accent);
            box-shadow: 0 0 16px rgba(141, 252, 255, .22);
        }

        .track .note {
            font-variant-numeric: tabular-nums;
            font-size: 28px;
            font-weight: 720;
            letter-spacing: .5px;
            color: rgba(255, 255, 255, .92);
            min-height: 34px;
            display: flex;
            align-items: flex-end;
        }

        .track .note.empty {
            color: rgba(255, 255, 255, .18);
            font-weight: 650;
        }

        /* 2-column section */
        .two {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 900px) {
            .tracks {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }

        @media (max-width: 560px) {
            .tracks {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .two {
                grid-template-columns: 1fr;
            }
        }

        /* Toggle switch */
        .toggleRow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
        }

        .toggleWrap {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggleLabel {
            font-size: 13px;
            color: rgba(255, 255, 255, .82);
            font-weight: 650;
            letter-spacing: .25px;
        }

        .switch {
            position: relative;
            width: 56px;
            height: 32px;
            flex: 0 0 auto;
        }

        .switch input {
            appearance: none;
            -webkit-appearance: none;
            width: 56px;
            height: 32px;
            background: rgba(255, 255, 255, .05);
            border: 1px solid var(--border);
            border-radius: 999px;
            outline: none;
            cursor: pointer;
            transition: background .15s, border-color .15s;
        }

        .switch input::before {
            content: "";
            position: absolute;
            top: 5px;
            left: 6px;
            width: 22px;
            height: 22px;
            border-radius: 999px;
            background: rgba(255, 255, 255, .75);
            transition: transform .18s ease, background .15s;
            box-shadow: 0 8px 18px rgba(0, 0, 0, .35);
        }

        .switch input:checked {
            background: rgba(141, 252, 255, .12);
            border-color: rgba(141, 252, 255, .35);
        }

        .switch input:checked::before {
            transform: translateX(22px);
            background: var(--accent);
            box-shadow: 0 0 18px rgba(141, 252, 255, .20), 0 8px 18px rgba(0, 0, 0, .35);
        }

        .smallActions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .smallActions button {
            width: auto;
            min-width: 160px;
        }

        hr.sep {
            border: none;
            border-top: 1px solid rgba(255, 255, 255, .06);
            margin: 10px 0 0;
        }
    </style>
</head>

<body>
    <div class="app">
        <header>
            <div>
                <h1>M8 Web MIDI — 8-Track Scale Sender</h1>
                <div class="subtitle">Pick an output device (M8), choose root + scale, toggle output to send notes on
                    channels 1–8.</div>
            </div>
            <div class="subtitle" id="supportNote"></div>
        </header>

        <!-- SECTION 1: MIDI Output Device -->
        <section>
            <div class="section-title">
                <h2>1) MIDI Output Device</h2>
                <div class="hint">You must grant MIDI access once per page load.</div>
            </div>

            <div class="row" style="align-items:flex-end;">
                <div style="flex:2 1 280px;">
                    <label for="outSelect">Output</label>
                    <select id="outSelect" disabled>
                        <option value="">(connect first)</option>
                    </select>
                </div>

                <div style="flex:1 1 220px;">
                    <label>&nbsp;</label>
                    <button id="btnConnect" class="primary">Connect MIDI</button>
                </div>

                <div style="flex:1 1 220px;">
                    <label>&nbsp;</label>
                    <button id="btnPanic" class="danger" disabled>Panic (All Notes Off)</button>
                </div>
            </div>

            <div class="status" id="midiStatus">
                <strong>Status:</strong> <span class="bad">Not connected.</span>
            </div>
        </section>

        <!-- SECTION 2: 8 Track Visualization -->
        <section>
            <div class="section-title">
                <h2>2) Track Visualization</h2>
                <div class="hint">Shows the active MIDI note number per channel (1–8).</div>
            </div>

            <div class="tracks" id="tracks"></div>
        </section>

        <!-- SECTION 3: Root + Scale -->
        <section>
            <div class="section-title">
                <h2>3) Root Note + Scale</h2>
                <div class="hint">Changing these while output is ON will update the notes.</div>
            </div>

            <div class="two">
                <div>
                    <label for="rootSelect">Root note</label>
                    <select id="rootSelect" disabled></select>
                </div>
                <div>
                    <label for="scaleSelect">Scale / mode</label>
                    <select id="scaleSelect" disabled></select>
                </div>
            </div>
        </section>

        <!-- SECTION 4: Output Toggle -->
        <section>
            <div class="section-title">
                <h2>4) Output</h2>
                <div class="hint">Toggle ON sends 8 notes (one per channel). Toggle OFF sends Note Off.</div>
            </div>

            <div class="toggleRow">
                <div class="toggleWrap">
                    <div class="switch">
                        <input id="outputToggle" type="checkbox" disabled />
                    </div>
                    <div class="toggleLabel" id="toggleLabel">Output OFF</div>
                </div>

                <div class="smallActions">
                    <button id="btnResend" disabled>Resend Notes</button>
                </div>
            </div>

            <hr class="sep" />
            <div class="status" id="notePlan">
                <strong>Planned notes:</strong> —
            </div>
        </section>
    </div>

    <script>
		// ----------------------------
		// MIDI + Music helpers
		// ----------------------------
		const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

		// Offsets (in semitones) from root within 1 octave
		const SCALES = [
			{ name: "Major (Ionian)", offsets: [0,2,4,5,7,9,11] },
			{ name: "Natural Minor (Aeolian)", offsets: [0,2,3,5,7,8,10] },
			{ name: "Dorian", offsets: [0,2,3,5,7,9,10] },
			{ name: "Phrygian", offsets: [0,1,3,5,7,8,10] },
			{ name: "Lydian", offsets: [0,2,4,6,7,9,11] },
			{ name: "Mixolydian", offsets: [0,2,4,5,7,9,10] },
			{ name: "Locrian", offsets: [0,1,3,5,6,8,10] },
			{ name: "Pentatonic Major", offsets: [0,2,4,7,9] },
			{ name: "Pentatonic Minor", offsets: [0,3,5,7,10] },
		];

		function midiToName(n){
			const name = NOTE_NAMES[n % 12];
			const oct = Math.floor(n / 12) - 1; // MIDI standard: 60 = C4
			return `${name}${oct}`;
		}

		function buildScaleNotes(rootMidi, offsets, count){
			const m = offsets.length;
			const notes = [];
			for(let i=0;i<count;i++){
				const degree = i % m;
				const oct = Math.floor(i / m);
				notes.push(rootMidi + offsets[degree] + 12 * oct);
			}
			return notes;
		}

		// ----------------------------
		// App state
		// ----------------------------
		let midiAccess = null;
		let currentOutput = null;			// MIDIOutput
		let currentOutputId = "";
		let enabled = false;

		// Track active notes per channel 1..8 (store MIDI note number or -1)
		let activeNotes = Array(8).fill(-1);

		// Last "planned" notes (so we can update on root/scale change)
		let plannedNotes = Array(8).fill(-1);

		const els = {
			supportNote: document.getElementById("supportNote"),
			outSelect: document.getElementById("outSelect"),
			btnConnect: document.getElementById("btnConnect"),
			btnPanic: document.getElementById("btnPanic"),
			midiStatus: document.getElementById("midiStatus"),

			tracks: document.getElementById("tracks"),

			rootSelect: document.getElementById("rootSelect"),
			scaleSelect: document.getElementById("scaleSelect"),

			outputToggle: document.getElementById("outputToggle"),
			toggleLabel: document.getElementById("toggleLabel"),
			btnResend: document.getElementById("btnResend"),

			notePlan: document.getElementById("notePlan"),
		};

		// ----------------------------
		// UI init
		// ----------------------------
		function initTracksUI(){
			els.tracks.innerHTML = "";
			for(let ch=1; ch<=8; ch++){
				const card = document.createElement("div");
				card.className = "track";
				card.dataset.ch = String(ch);

				const top = document.createElement("div");
				top.className = "ch";
				top.innerHTML = `<span>CH ${ch}</span><span class="dot" aria-hidden="true"></span>`;

				const note = document.createElement("div");
				note.className = "note empty";
				note.textContent = "—";
				note.dataset.role = "note";

				card.appendChild(top);
				card.appendChild(note);
				els.tracks.appendChild(card);
			}
			renderTracks();
		}

		function renderTracks(){
			for(let i=0;i<8;i++){
				const ch = i + 1;
				const card = els.tracks.querySelector(`.track[data-ch="${ch}"]`);
				const noteEl = card.querySelector(`[data-role="note"]`);
				const n = activeNotes[i];

				if(n >= 0){
					card.classList.add("active");
					noteEl.classList.remove("empty");
					noteEl.textContent = String(n);
				}else{
					card.classList.remove("active");
					noteEl.classList.add("empty");
					noteEl.textContent = "—";
				}
			}
		}

		function setStatus(html){
			els.midiStatus.innerHTML = `<strong>Status:</strong> ${html}`;
		}

		function setEnabledUI(canUse){
			els.outSelect.disabled = !canUse;
			els.rootSelect.disabled = !canUse;
			els.scaleSelect.disabled = !canUse;
			els.outputToggle.disabled = !canUse || !currentOutput;
			els.btnPanic.disabled = !canUse || !currentOutput;
			els.btnResend.disabled = !canUse || !currentOutput;
		}

		function updateToggleLabel(){
			els.toggleLabel.textContent = enabled ? "Output ON" : "Output OFF";
		}

		function updateNotePlanText(){
			const parts = plannedNotes.map((n,i)=> `CH${i+1}:${n>=0? n : "—"}`);
			const root = Number(els.rootSelect.value || 60);
			const scale = SCALES[Number(els.scaleSelect.value || 0)];
			els.notePlan.innerHTML = `<strong>Planned notes:</strong> ${parts.join("  •  ")} <span style="color:rgba(255,255,255,.45);">(${midiToName(root)} / ${scale.name})</span>`;
		}

		function populateRootSelect(){
			els.rootSelect.innerHTML = "";
			// A practical range for M8: C1 (24) through B7 (107) is fine; we’ll do 24..96 to start.
			for(let n=24; n<=96; n++){
				const opt = document.createElement("option");
				opt.value = String(n);
				opt.textContent = `${midiToName(n)} (${n})`;
				els.rootSelect.appendChild(opt);
			}
			els.rootSelect.value = "60"; // C4
		}

		function populateScaleSelect(){
			els.scaleSelect.innerHTML = "";
			SCALES.forEach((s, idx)=>{
				const opt = document.createElement("option");
				opt.value = String(idx);
				opt.textContent = s.name;
				els.scaleSelect.appendChild(opt);
			});
			els.scaleSelect.value = "0";
		}

		// ----------------------------
		// MIDI send helpers
		// ----------------------------
		function sendNoteOn(ch1, note, vel=96){
			if(!currentOutput) return;
			const ch0 = Math.max(0, Math.min(15, ch1 - 1));
			currentOutput.send([0x90 + ch0, note & 0x7F, vel & 0x7F]);
		}

		function sendNoteOff(ch1, note){
			if(!currentOutput) return;
			const ch0 = Math.max(0, Math.min(15, ch1 - 1));
			currentOutput.send([0x80 + ch0, note & 0x7F, 0x00]);
		}

		function sendAllNotesOff(){
			if(!currentOutput) return;
			for(let ch1=1; ch1<=16; ch1++){
				const ch0 = ch1 - 1;
				// CC 123 = All Notes Off
				currentOutput.send([0xB0 + ch0, 123, 0]);
				// CC 120 = All Sound Off (extra safety)
				currentOutput.send([0xB0 + ch0, 120, 0]);
			}
		}

		function hardStopNotes(){
			// Turn off whatever we think is on, then do CC all-notes-off as backup.
			for(let i=0;i<8;i++){
				const ch = i+1;
				const n = activeNotes[i];
				if(n >= 0) sendNoteOff(ch, n);
				activeNotes[i] = -1;
			}
			sendAllNotesOff();
			renderTracks();
		}

		// ----------------------------
		// Note planning + applying
		// ----------------------------
		function computePlannedNotes(){
			const root = Number(els.rootSelect.value || 60);
			const scale = SCALES[Number(els.scaleSelect.value || 0)];
			const notes = buildScaleNotes(root, scale.offsets, 8);
			plannedNotes = notes.map(n => Math.max(0, Math.min(127, n)));
			updateNotePlanText();
		}

		function applyNotesIfEnabled(){
			computePlannedNotes();

			if(!enabled) return;
			if(!currentOutput){
				enabled = false;
				els.outputToggle.checked = false;
				updateToggleLabel();
				setStatus(`<span class="bad">No output selected.</span>`);
				return;
			}

			// For each channel, if note changed, send off old, on new
			for(let i=0;i<8;i++){
				const ch = i+1;
				const oldN = activeNotes[i];
				const newN = plannedNotes[i];

				if(oldN === newN && oldN >= 0) continue;

				if(oldN >= 0) sendNoteOff(ch, oldN);
				sendNoteOn(ch, newN, 96);
				activeNotes[i] = newN;
			}

			renderTracks();
		}

		// ----------------------------
		// MIDI device management
		// ----------------------------
		function refreshOutputList(){
			const prev = currentOutputId;

			els.outSelect.innerHTML = "";
			const placeholder = document.createElement("option");
			placeholder.value = "";
			placeholder.textContent = "(select an output device)";
			els.outSelect.appendChild(placeholder);

			if(!midiAccess) return;

			const outputs = Array.from(midiAccess.outputs.values());
			outputs.sort((a,b)=> (a.name||"").localeCompare(b.name||""));

			for(const out of outputs){
				const opt = document.createElement("option");
				opt.value = out.id;
				opt.textContent = `${out.name || "Unnamed"}${out.manufacturer ? " — " + out.manufacturer : ""}`;
				els.outSelect.appendChild(opt);
			}

			// Restore selection if possible
			if(prev && outputs.some(o=>o.id === prev)){
				els.outSelect.value = prev;
				selectOutput(prev, {silent:true});
			}else{
				els.outSelect.value = "";
				selectOutput("", {silent:true});
			}
		}

		function selectOutput(id, {silent=false}={}){
			// If switching while enabled, stop notes on old output first to avoid stuck notes.
			if(enabled && currentOutput){
				hardStopNotes();
			}

			currentOutputId = id || "";
			currentOutput = null;

			if(midiAccess && id){
				currentOutput = midiAccess.outputs.get(id) || null;
			}

			setEnabledUI(!!midiAccess);

			if(!silent){
				if(currentOutput){
					setStatus(`<span class="ok">Connected.</span> Output: <strong>${currentOutput.name || "Unnamed"}</strong>`);
				}else{
					setStatus(`<span class="bad">Connected, but no output selected.</span>`);
				}
			}

			// If enabled and we now have an output, resend the notes onto the new device.
			if(enabled && currentOutput){
				applyNotesIfEnabled();
			}
		}

		// ----------------------------
		// Events
		// ----------------------------
		async function connectMIDI(){
			if(!navigator.requestMIDIAccess){
				els.supportNote.textContent = "Web MIDI not supported in this browser.";
				setStatus(`<span class="bad">Web MIDI not supported.</span> Try Chrome or Edge.`);
				return;
			}

			try{
				midiAccess = await navigator.requestMIDIAccess({ sysex: false });
				midiAccess.onstatechange = () => refreshOutputList();

				refreshOutputList();
				setEnabledUI(true);

				setStatus(`<span class="ok">Connected.</span> Select your M8 from the Output list.`);
			}catch(err){
				setStatus(`<span class="bad">Permission denied or unavailable.</span> ${String(err)}`);
			}
		}

		els.btnConnect.addEventListener("click", async ()=>{
			await connectMIDI();
		});

		els.outSelect.addEventListener("change", ()=>{
			selectOutput(els.outSelect.value);
		});

		els.rootSelect.addEventListener("change", ()=>{
			applyNotesIfEnabled();
		});

		els.scaleSelect.addEventListener("change", ()=>{
			applyNotesIfEnabled();
		});

		els.outputToggle.addEventListener("change", ()=>{
			const wantOn = els.outputToggle.checked;

			if(wantOn){
				if(!currentOutput){
					els.outputToggle.checked = false;
					enabled = false;
					updateToggleLabel();
					setStatus(`<span class="bad">Select an output first.</span>`);
					return;
				}
				enabled = true;
				updateToggleLabel();
				applyNotesIfEnabled();
				setStatus(`<span class="ok">Output ON.</span> Sending notes on channels 1–8.`);
			}else{
				enabled = false;
				updateToggleLabel();
				hardStopNotes();
				setStatus(`<span class="ok">Output OFF.</span> Notes released.`);
			}
		});

		els.btnPanic.addEventListener("click", ()=>{
			hardStopNotes();
			setStatus(`<span class="ok">Panic sent.</span> All Notes Off / All Sound Off.`);
		});

		els.btnResend.addEventListener("click", ()=>{
			if(!currentOutput){
				setStatus(`<span class="bad">No output selected.</span>`);
				return;
			}
			if(enabled){
				// Turn off then resend, cleanly.
				hardStopNotes();
				applyNotesIfEnabled();
				setStatus(`<span class="ok">Resent notes.</span>`);
			}else{
				setStatus(`<span class="ok">Ready.</span> Turn Output ON to send notes.`);
			}
		});

		// ----------------------------
		// Boot
		// ----------------------------
		(function boot(){
			initTracksUI();
			populateRootSelect();
			populateScaleSelect();
			computePlannedNotes();

			const supported = !!navigator.requestMIDIAccess;
			els.supportNote.textContent = supported ? "Web MIDI supported" : "Web MIDI NOT supported";
			setEnabledUI(false);
			updateToggleLabel();

			if(!supported){
				setStatus(`<span class="bad">Web MIDI not supported.</span> Use Chrome/Edge, and run from https:// or localhost.`);
			}
		})();
    </script>
</body>

</html>